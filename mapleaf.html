<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Polygons with Automatic Coordinate Detection</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .input-container {
            margin-bottom: 10px;
        }
        .legend {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend-item {
            margin-bottom: 5px;
        }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <h1>Polygons with Automatic DMS or Decimal Input</h1>
    
    <!-- Step 1: Choose number of polygons -->
    <form id="polygonCountForm">
        <label for="polygonCount">How many polygons do you want to draw? </label>
        <input type="number" id="polygonCount" min="1" max="5" required>
        <button type="submit">Next</button>
    </form>

    <!-- Coordinate Input Form -->
    <form id="coordinateForm" style="display: none;">
        <div id="coordinateSets"></div> <!-- Dynamically populated coordinate inputs -->
        <button type="submit">Draw Polygons</button>
    </form>

    <!-- Div to display the map -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        // Initialize the map and set the default view
        var map = L.map('map').setView([0, 0], 2); // Default to (0, 0) and zoom level 2

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Colors for the polygons
        const colors = ['blue', 'green', 'red', 'orange', 'purple'];
        const polygons = []; // To store polygon objects for legends

        // Handle the polygon count form submission
        document.getElementById('polygonCountForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var polygonCount = parseInt(document.getElementById('polygonCount').value);

            // Generate coordinate input forms based on polygon count
            generateCoordinateForms(polygonCount);

            // Show the coordinate form
            document.getElementById('coordinateForm').style.display = 'block';
        });

        // Function to dynamically generate coordinate input forms
        function generateCoordinateForms(polygonCount) {
            var coordinateSetsDiv = document.getElementById('coordinateSets');
            coordinateSetsDiv.innerHTML = ''; // Clear previous inputs

            for (let i = 1; i <= polygonCount; i++) {
                let polygonHTML = `
                    <h3>Polygon ${i}:</h3>
                    <label for="name${i}">Name of Polygon: </label>
                    <input type="text" id="name${i}" required placeholder="Polygon ${i} Name">
                    <label for="points${i}">How many coordinates? (min 3): </label>
                    <input type="number" id="points${i}" min="3" required value="4">
                    <div id="coordinateSet${i}"></div>
                    <button type="button" onclick="generateCoordinateFields(${i})">Generate Coordinates</button>
                    <hr/>
                `;
                coordinateSetsDiv.insertAdjacentHTML('beforeend', polygonHTML);
            }
        }

        // Generate fields to accept either DMS or Decimal Degrees
        function generateCoordinateFields(polygonId) {
            var points = document.getElementById(`points${polygonId}`).value;
            var coordinateSetDiv = document.getElementById(`coordinateSet${polygonId}`);
            coordinateSetDiv.innerHTML = ''; // Clear previous fields

            for (let j = 1; j <= points; j++) {
                let coordinateFields = `
                    <div class="input-container">
                        <label>Coordinate ${j} (Lat, Lng): </label>
                        Lat: <input type="text" id="lat${polygonId}_${j}" placeholder="e.g. 40 26 46 N or 40.446">
                        Lng: <input type="text" id="lng${polygonId}_${j}" placeholder="e.g. 79 58 56 W or -79.982">
                    </div>
                `;
                coordinateSetDiv.insertAdjacentHTML('beforeend', coordinateFields);
            }
        }

        // Helper function to detect DMS format and convert to Decimal Degrees
        function convertToDecimal(input) {
            // Check if the input contains spaces (indicating DMS format)
            let parts = input.trim().split(/\s+/);
            if (parts.length === 1) {
                // Assume it's already in Decimal Degrees
                return parseFloat(input);
            } else if (parts.length === 3 || parts.length === 4) {
                // Convert from DMS to Decimal Degrees
                let degrees = parseFloat(parts[0]);
                let minutes = parseFloat(parts[1]);
                let seconds = parseFloat(parts[2]);
                let direction = parts.length === 4 ? parts[3].toUpperCase() : null;

                let decimal = degrees + (minutes / 60) + (seconds / 3600);
                if (direction === 'S' || direction === 'W') {
                    decimal = decimal * -1;
                }
                return decimal;
            } else {
                alert("Invalid coordinate format. Please use either DMS or Decimal Degrees.");
                return null;
            }
        }

        // Form submit event listener for drawing polygons
        document.getElementById('coordinateForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent page refresh on form submission

            // Get the number of polygons
            var polygonCount = parseInt(document.getElementById('polygonCount').value);

            // Clear existing layers (polygons) and reset legend
            map.eachLayer(function (layer) {
                if (layer instanceof L.Polygon) {
                    map.removeLayer(layer);
                }
            });
            polygons.length = 0;

            // Loop through each polygon set and draw them
            for (let i = 1; i <= polygonCount; i++) {
                var points = parseInt(document.getElementById(`points${i}`).value);
                var coordinates = [];
                var name = document.getElementById(`name${i}`).value;

                for (let j = 1; j <= points; j++) {
                    var latInput = document.getElementById(`lat${i}_${j}`).value;
                    var lngInput = document.getElementById(`lng${i}_${j}`).value;

                    // Convert to Decimal Degrees if necessary
                    var lat = convertToDecimal(latInput);
                    var lng = convertToDecimal(lngInput);

                    // Ensure valid coordinates before adding
                    if (lat !== null && lng !== null) {
                        coordinates.push([lat, lng]);
                    }
                }

                // Draw the polygon with a unique color
                var polygon = L.polygon(coordinates, { color: colors[i - 1] }).addTo(map);
                polygons.push({ polygon: polygon, color: colors[i - 1], name: name });
            }

            // Fit map to bounds of all polygons
            var bounds = [];
            map.eachLayer(function (layer) {
                if (layer instanceof L.Polygon) {
                    bounds = bounds.concat(layer.getLatLngs()[0]);
                }
            });
            map.fitBounds(bounds);

            // Add the legend to the map
            addLegend(polygons);
        });

        // Function to add legend to the map
        function addLegend(polygons) {
            var legend = L.control({ position: 'bottomright' });

            legend.onAdd = function () {
                var div = L.DomUtil.create('div', 'legend');
                polygons.forEach(function (item) {
                    div.innerHTML += `
                        <div class="legend-item">
                            <span class="legend-color" style="background-color:${item.color};"></span>
                            ${item.name}
                        </div>
                    `;
                });
                return div;
            };

            legend.addTo(map);
        }
    </script>

</body>
</html>
